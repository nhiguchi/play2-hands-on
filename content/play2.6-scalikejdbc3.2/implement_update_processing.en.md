---
title: Implement the User registration and update methods
---

We will validate the input values and perform the following process depending on whether there is an error.

* Error ⇒ Set error information in the form and return to the form input.
* No Error ⇒ Register/Update the user info in DB and redirect to the user list page.

## Controller

We will implement the `create` method for registration and `update` method to update the user info in `UserController` class. 

入力フォームの値を受け取るには、`userForm.bindFromRequest`メソッドでリクエストの内容をFormにバインドし、`fold`メソッドでエラーがあった場合の処理と、OKの場合の処理を記述します。以下は`create`メソッドの実装例です。
To receive the value of the input form, bind the content of the request to the Form with the `userForm.bindFromRequest` method, and describe the corresponding processes for OK and NG scenarios, in the` fold` method. Following is the implementation of `create` method.

```scala
def create = Action { implicit request =>
  DB.localTx { implicit session =>
    // bind the request contents
    userForm.bindFromRequest.fold(
      // Error
      error => {
        BadRequest(views.html.user.edit(error, Companies.findAll()))
      },
      // OK
      form  => {
        // Register User
        Users.create(form.name, form.companyId)
        // Redirect to user list page
        Redirect(routes.UserController.list)
      }
    )
  }
}
```

Similarly implement the `update` method.

```scala
def update = Action { implicit request =>
  DB.localTx { implicit session =>
    // Bind the contents of request
    userForm.bindFromRequest.fold(
      // In case of error, return to the edit page
      error => {
        BadRequest(views.html.user.edit(error, Companies.findAll()))
      },
      // OK, update the user info and redirect to user list page
      form => {
        Users.find(form.id.get).foreach { user =>
          Users.save(user.copy(name = form.name, companyId = form.companyId))
        }
        Redirect(routes.UserController.list)
      }
    )
  }
}
```

Again, we will use the methods automatically generated by scalikejdbcGen, such as `Users.create ()` for INSERT and `Users.save ()` for UPDATE. These methods can be rewritten using QueryDSL as following.

```scala
// Overwrite the INSERT method using QueryDSL
val generatedKey = withSQL {
  val column = Users.column
  insert.into(Users).namedValues(
    column.name -> form.name,
    column.companyId -> form.companyId
  )
}.updateAndReturnGeneratedKey.apply()

// Overwrite the UPDATE method with QueryDSL
withSQL {
  val column = Users.column
  QueryDSL.update(Users).set(
    column.name -> form.name,
    column.companyId -> form.companyId
  ).where.eq(column.id, user.id)
}.update.apply()
```

> **POINT**
>
> * As described in the HTML template, the redirect destination can be specified as type-safe with `routes ....`.
> * We can retrieve the transaction session using `DB.localTx { ... }`.
>   * It commits the task if completed successfully, otherwise in case of an exception, perform the automatic rollback.

## Run


After implementing this far, we will confirm that user information can be registered and edited from the registration screen and edit screen. And if we try to register the user name with blank or more than 20 characters, an error message will be displayed and we should be able to confirm that the validation is working properly.

**In case of validation error:**

![Validation Error](../images/play2.6-scalikejdbc3.2/validation.png)
